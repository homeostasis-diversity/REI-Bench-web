import React, { useState, useEffect } from "react";
import { Button } from "@/components/ui/button";

// 字符级 diff 辅助函数
function findDiff(oldText: string, newText: string) {
  let start = 0;
  while (start < oldText.length && oldText[start] === newText[start]) {
    start++;
  }

  let end = 0;
  while (
    end < oldText.length - start &&
    end < newText.length - start &&
    oldText[oldText.length - 1 - end] === newText[newText.length - 1 - end]
  ) {
    end++;
  }

  return {
    prefix: newText.slice(0, start),
    diff: newText.slice(start, newText.length - end),
    suffix: newText.slice(newText.length - end),
  };
}

export default function TypingDiff() {
  const [text, setText] = useState("Hello, this is version one.");
  const [displayed, setDisplayed] = useState("");
  const [isTyping, setIsTyping] = useState(false);

  const nextText = "Hello, this is version two.";

  // 初始打字
  useEffect(() => {
    typeText(text);
  }, []);

  const typeText = (fullText: string) => {
    setIsTyping(true);
    let i = 0;
    const interval = setInterval(() => {
      setDisplayed(fullText.slice(0, i + 1));
      i++;
      if (i >= fullText.length) {
        clearInterval(interval);
        setIsTyping(false);
      }
    }, 40);
  };

  const changeText = () => {
    if (isTyping) return;

    const diff = findDiff(text, nextText);
    const { prefix, diff: newPart, suffix } = diff;

    setIsTyping(true);
    setDisplayed(prefix); // 保留前缀
    let i = 0;
    const interval = setInterval(() => {
      setDisplayed(prefix + newPart.slice(0, i + 1));
      i++;
      if (i >= newPart.length) {
        clearInterval(interval);
        setDisplayed(prefix + newPart + suffix);
        setText(nextText);
        setIsTyping(false);
      }
    }, 40);
  };

  return (
    <div className="p-4 max-w-xl mx-auto">
      <div className="border p-4 text-lg font-mono min-h-[3rem] bg-black text-white rounded-md">
        {displayed}
      </div>
      <Button className="mt-4" onClick={changeText} disabled={isTyping}>
        Change
      </Button>
    </div>
  );
}
