<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Typing Diff Demo</title>
  <link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/diff-match-patch@1.0.5/index.js"></script>
  <style>
    body {
      font-family: 'Roboto', sans-serif;
      background: #121212;
      color: #ffffff;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }

    #text-box {
      background: #1e1e1e;
      border: 2px solid #444;
      padding: 1rem;
      font-family: monospace;
      font-size: 1.2rem;
      white-space: pre-wrap;
      width: 600px;
      min-height: 100px;
      border-radius: 8px;
    }

    button {
      margin-top: 1rem;
      padding: 0.5rem 1rem;
      font-size: 1rem;
      background-color: #007bff;
      border: none;
      border-radius: 4px;
      color: white;
      cursor: pointer;
    }

    button:disabled {
      background-color: #555;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div id="text-box"></div>
  <button id="change-btn">Change</button>

  <script>
    const box = document.getElementById('text-box');
    const button = document.getElementById('change-btn');

    let oldText = "Hello, this is version one.";
    let newText = "Hello, this is version two.";

    const dmp = new diff_match_patch();

    // 打字函数
    function typeDiff(diffs, callback) {
      let result = '';
      let i = 0;
      let charIndex = 0;

      function step() {
        if (i >= diffs.length) {
          if (callback) callback();
          return;
        }

        const [op, data] = diffs[i];
        if (op === 0) {  // 相同的部分，立即加入
          result += data;
          box.textContent = result;
          i++;
          step();
        } else if (op === 1) {  // 插入部分，逐字打出
          if (charIndex < data.length) {
            result += data[charIndex];
            box.textContent = result;
            charIndex++;
            setTimeout(step, 40);
          } else {
            i++;
            charIndex = 0;
            step();
          }
        } else if (op === -1) {  // 删除部分，不显示
          i++;
          step();
        }
      }

      step();
    }

    // 初始打字机效果
    function typeInitial(text, callback) {
      let i = 0;
      function step() {
        if (i <= text.length) {
          box.textContent = text.slice(0, i);
          i++;
          setTimeout(step, 40);
        } else {
          if (callback) callback();
        }
      }
      step();
    }

    // 启动
    button.disabled = true;
    typeInitial(oldText, () => {
      button.disabled = false;
    });

    // 点击 change
    button.onclick = () => {
      button.disabled = true;
      const diffs = dmp.diff_main(oldText, newText);
      dmp.diff_cleanupSemantic(diffs);
      typeDiff(diffs, () => {
        oldText = newText;
        button.disabled = false;
      });
    };
  </script>
</body>
</html>
